# This file contains common pin mappings for the BigTreeTech Octopus
# Pro v1.0 board.

# Important! Do not use this config with an Octopus Pro v1.1 board as
# doing so could result in a heater being inadvertently enabled.

# To use this config, start by identifying the micro-controller on the
# board - it may be an STM32F446, STM32F429, or an STM32H723.  Select
# the appropriate micro-controller in "make menuconfig" and select
# "Enable low-level configuration options". For STM32F446 boards the
# firmware should be compiled with a "32KiB bootloader" and a "12MHz
# crystal" clock reference. For STM32F429 boards use a "32KiB
# bootloader" and an "8MHz crystal". For STM32H723 boards use a
# "128KiB bootloader" and a "25Mhz crystal".

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT
[display_status]
[pause_resume]
[exclude_object]

[respond]

[save_variables]
filename: ~/variables.cfg
#   Required - provide a filename that would be used to save the
#   variables to disk e.g. ~/variables.cfg

[delayed_gcode STARTUP_GCODE]
initial_duration: 0.1
gcode:
	{% set svv = printer.save_variables.variables %}
    {% if svv.loadstatus != "" %}
	SAVE_VARIABLE VARIABLE=loadstatus VALUE='"loaded"'
    {% endif %}
	set_pressure_advance extruder=extruder advance=0.45 smooth_time=0.04
	set_pressure_advance extruder=extruder1 advance=0.45 smooth_time=0.04
    

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f429xx_1B00380015504E5242343120-if00

#[mcu btt_lis2dw]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_455035712910D238-if00

#[lis2dw]
#cs_pin: btt_lis2dw:gpio9
#spi_bus: spi1a
#spi_software_sclk_pin: btt_lis2dw:gpio10
#spi_software_mosi_pin: btt_lis2dw:gpio11
#spi_software_miso_pin: btt_lis2dw:gpio8
#axes_map: -y,x,-z

#[resonance_tester]
#probe_points: 100, 100, 20
#accel_chip: lis2dw

[input_shaper]
shaper_freq_x: 87.6
shaper_type_x: ei
shaper_freq_y: 50.2
shaper_type_y: ei

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100


# Driver0
[stepper_x]
step_pin: PF13
dir_pin: !PF12
enable_pin: !PF14
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -1
position_endstop: -1
position_max: 255
homing_speed: 50
homing_retract_dist: 0

# Driver1
[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -6
position_endstop: -6
position_max: 255
homing_speed: 50
homing_retract_dist: 0

# Driver2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 250

# Driver3
[stepper_z1]
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 8


# Driver4
[extruder]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 16
rotation_distance: 7.71
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA2 # HE0
sensor_pin:  PF4 # T0
sensor_type: ATC Semitec 104GT-2
pressure_advance: 0.5
max_extrude_only_distance: 550
max_extrude_only_velocity: 30
max_extrude_cross_section: 50
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
min_temp: 0
max_temp: 250


#[filament_motion_sensor T0_Run_Out_Sensor]
#detection_length: 7.0
#extruder:extruder
#switch_pin: PG12

# Driver5
#[extruder1]
#nozzle_diameter: 0.400
#filament_diameter: 1.750
#step_pin: PC13
#dir_pin: !PF0
#enable_pin: !PF1
#microsteps: 16
#rotation_distance: 7.71
#pressure_advance: 0.40
#max_extrude_only_distance: 550
#max_extrude_only_velocity: 30
#max_extrude_cross_section: 50
#shared_heater: extruder

# Driver5
[extruder_stepper extruder1]
extruder: 
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
microsteps: 16
rotation_distance: 7.71

#[filament_motion_sensor T1_Run_Out_Sensor]
#detection_length: 7.0
#extruder:extruder
#switch_pin: PG13

[heater_bed]
heater_pin: PA1
sensor_pin: PF3 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 132
#pid_Ki: 25
#pid_Kd: 456
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[multi_pin my_fan]
pins:PA8,PE5

[fan]
pin: multi_pin:my_fan

[heater_fan Hotend_Fan]
pin: PD12

[controller_fan CPU_Fan]
pin: PD13

########################################
# TMC2209 configuration
########################################

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: PG6
run_current: 0.600
driver_SGTHRS: 125 
stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
run_current: 0.600
driver_SGTHRS: 125 
stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PC6
diag_pin: PG10
run_current: 0.600
stealthchop_threshold: 999999

[tmc2209 stepper_z1]
uart_pin: PC7
diag_pin: PG11
run_current: 0.600
stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PF2
run_current: 0.600
stealthchop_threshold: 999999

[tmc2209 extruder_stepper extruder1]
uart_pin: PE4
run_current: 0.600
stealthchop_threshold: 999999


# A [probe] section can be defined instead with a pin: setting identical
# to the sensor_pin: for a bltouch
[bltouch]
sensor_pin: PB7
control_pin: PB6
x_offset: -40.6
y_offset: -9.1
#z_offset: 4.1


[bed_mesh] 
mesh_min: 5, 5 
mesh_max: 200, 235
probe_count: 6, 6 
speed: 50
horizontal_move_z: 7
adaptive_margin: 5

[z_tilt]
z_positions: -30,110
  265,110 
points: 60,110
  230,110
retries: 5
retry_tolerance: 0.02 
speed:120
horizontal_move_z: 7

[screws_tilt_adjust]
screw1: 87, 32
screw1_name: Front Left
screw2: 255, 32
screw2_name: Front Right
screw3: 87, 202
screw3_name: Rear Left
screw4: 255, 202
screw4_name: Rear Right
horizontal_move_z: 7
screw_thread: CW-M3
#   The type of screw used for bed leveling, M3, M4, or M5, and the
#   rotation direction of the knob that is used to level the bed.
#   Accepted values: CW-M3, CCW-M3, CW-M4, CCW-M4, CW-M5, CCW-M5.
#   Default value is CW-M3 which most printers use. A clockwise
#   rotation of the knob decreases the gap between the nozzle and the
#   bed. Conversely, a counter-clockwise rotation increases the gap.



[safe_z_home]
home_xy_position: 100, 100 # Change coordinates to the center of your print bed
speed: 50
z_hop: 10               # Move up 10mm
z_hop_speed: 5


[gcode_macro T0]
gcode:
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder" MOTION_QUEUE="extruder"
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder1" MOTION_QUEUE=""
    #SET_FILAMENT_SENSOR SENSOR=T0_Run_Out_Sensor ENABLE=1
    #SET_FILAMENT_SENSOR SENSOR=T1_Run_Out_Sensor ENABLE=0

[gcode_macro T1]
gcode:
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder" MOTION_QUEUE=""
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder1" MOTION_QUEUE="extruder"
    #SET_FILAMENT_SENSOR SENSOR=T0_Run_Out_Sensor ENABLE=0
    #SET_FILAMENT_SENSOR SENSOR=T1_Run_Out_Sensor ENABLE=1
    
[gcode_macro LOAD_FILAMENT]
variable_load_distance:  500
variable_purge_distance:  50
variable_purge_more_distance:  20
variable_unload_distance:  50
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.loadstatus == "unloaded" %}
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    #so we have now "loaded" but it might not be enough, lets ask if we should try some more?
    RESPOND TYPE=command MSG="action:prompt_begin Filiment Load"
    RESPOND TYPE=command MSG="action:prompt_text More Purge Required?"
    RESPOND TYPE=command MSG="action:prompt_footer_button PURGE|G1 E{purge_more_distance} F{speed}"
    RESPOND TYPE=command MSG="action:prompt_footer_button RESUME|FINISH_LOAD"
    #RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|CANCEL_PRINT|error"
    RESPOND TYPE=command MSG="action:prompt_show"
     
    #G1 E-{unload_distance} F{speed} # retract after load to parking
    #REMOVE_FILAMENT
    RESTORE_GCODE_STATE NAME=load_state
    SAVE_VARIABLE VARIABLE=loadstatus VALUE='"loaded"'
    { action_respond_info("Loaded") }
    {% else %}
    { action_respond_info("Error: Already loaded!") }
	{% endif %}
	
    
[gcode_macro FINISH_LOAD]
gcode:
  REMOVE_FILAMENT
  RESPOND TYPE=command MSG=action:prompt_end

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  500
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state
    SAVE_VARIABLE VARIABLE=loadstatus VALUE='"unloaded"'
    { action_respond_info("UnLoaded") }



[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
  ## Move head and retract only if not already in the pause state and park set to true

  {% if printer.pause_resume.is_paused|lower == 'false' and park|lower == 'true'%}
    _TOOLHEAD_PARK_PAUSE_CANCEL
  {% endif %}

# Ramming
  REMOVE_FILAMENT  
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE


[gcode_macro REMOVE_FILAMENT]
gcode:
# Ramming
    G91
    G92 E0
    G1 F3547
    G1 E0.6845
    G1 F3634
    G1 E0.7013
    G1 F3851
    G1 E0.7432
    G1 F4111
    G1 E0.5807
    G1 F4111
    G1 E0.2128
    G1 F4285
    G1 E0.8270
    G1 F4430
    G1 E0.8550
    G1 F4705
    G1 E0.8150
    G1 F7200
    G1 F4705
    G1 E0.0930
    G1 F5081
    G1 E0.9807
    G1 F5327
    G1 E1.028
    G1 F5385
    G1 E0.6079
    G1 F5385
    G1 E0.4315
    #Retract(unload)
  G1 E-15.0000 F1500
  G1 E-9.8000 F1800
  G1 E-2.8000 F900
  G1 E-1.4000 F540
  #Cooling
  G1 E5.0000 F3000
  G1 E-5.0000 F2786
  G1 E5.0000 F3000
  G1 E-5.0000 F2750
  G1 E5.0000 F3000
  G1 E-5.0000 F2700
  G1 E5.0000 F3000
  G1 E-5.0000 F2625
  #Cooling park
  G1 E-21.0000 F2000
  G92 E0
  G90

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.752
#*# pid_ki = 1.792
#*# pid_kd = 718.421
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 32.602
#*# pid_ki = 2.110
#*# pid_kd = 125.927
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.153014, 0.103014, 0.078014, 0.060514, 0.038014, 0.020514
#*# 	  0.090514, 0.058014, 0.055514, 0.065514, 0.068014, 0.083014
#*# 	  0.033014, 0.000514, -0.006986, 0.005514, 0.015514, 0.038014
#*# 	  0.110514, 0.058014, 0.028014, 0.038014, 0.040514, 0.048014
#*# 	  0.220514, 0.173014, 0.155514, 0.158014, 0.160514, 0.160514
#*# 	  0.470514, 0.410514, 0.390514, 0.403014, 0.415514, 0.455514
#*# x_count = 6
#*# y_count = 6
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 200.0
#*# min_y = 5.0
#*# max_y = 235.0
#*#
#*# [bltouch]
#*# z_offset = 3.930
