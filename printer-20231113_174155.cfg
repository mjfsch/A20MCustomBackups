# This file contains common pin mappings for the BigTreeTech Octopus
# Pro v1.0 board.

# Important! Do not use this config with an Octopus Pro v1.1 board as
# doing so could result in a heater being inadvertently enabled.

# To use this config, start by identifying the micro-controller on the
# board - it may be an STM32F446, STM32F429, or an STM32H723.  Select
# the appropriate micro-controller in "make menuconfig" and select
# "Enable low-level configuration options". For STM32F446 boards the
# firmware should be compiled with a "32KiB bootloader" and a "12MHz
# crystal" clock reference. For STM32F429 boards use a "32KiB
# bootloader" and an "8MHz crystal". For STM32H723 boards use a
# "128KiB bootloader" and a "25Mhz crystal".

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT
[display_status]
[pause_resume]
[exclude_object]

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f429xx_1B00380015504E5242343120-if00

#[mcu btt_lis2dw]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_455035712910D238-if00

#[lis2dw]
#cs_pin: btt_lis2dw:gpio9
#spi_bus: spi1a
#spi_software_sclk_pin: btt_lis2dw:gpio10
#spi_software_mosi_pin: btt_lis2dw:gpio11
#spi_software_miso_pin: btt_lis2dw:gpio8
#axes_map: -y,x,-z

#[resonance_tester]
#probe_points: 100, 100, 20
#accel_chip: lis2dw

[input_shaper]
shaper_freq_x: 87.6
shaper_type_x: ei
shaper_freq_y: 50.2
shaper_type_y: ei

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100


# Driver0
[stepper_x]
step_pin: PF13
dir_pin: !PF12
enable_pin: !PF14
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -1
position_endstop: -1
position_max: 255
homing_speed: 50
homing_retract_dist: 0

# Driver1
[stepper_y]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -6
position_endstop: -6
position_max: 255
homing_speed: 50
homing_retract_dist: 0

# Driver2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 250

# Driver3
[stepper_z1]
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 8


# Driver4
[extruder]
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 16
rotation_distance: 7.71
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA2 # HE0
sensor_pin:  PF4 # T0
sensor_type: ATC Semitec 104GT-2
pressure_advance: 0.40
max_extrude_only_distance: 550
max_extrude_only_velocity: 30
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
min_temp: 0
max_temp: 250


[filament_motion_sensor T0_Run_Out_Sensor]
detection_length: 7.0
extruder:extruder
switch_pin: PG12

# Driver5
[extruder1]
nozzle_diameter: 0.400
filament_diameter: 1.750
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
microsteps: 16
rotation_distance: 7.71
pressure_advance: 0.40
max_extrude_only_distance: 550
max_extrude_only_velocity: 40
shared_heater: extruder

[filament_motion_sensor T1_Run_Out_Sensor]
detection_length: 7.0
extruder:extruder1
switch_pin: PG13

[heater_bed]
heater_pin: PA1
sensor_pin: PF3 # TB
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 132
#pid_Ki: 25
#pid_Kd: 456
min_temp: 0
max_temp: 130

[multi_pin my_fan]
pins:PA8,PE5

[fan]
pin: multi_pin:my_fan

[heater_fan Hotend_Fan]
pin: PD12

[controller_fan CPU_Fan]
pin: PD13

########################################
# TMC2209 configuration
########################################

[tmc2209 stepper_x]
uart_pin: PC4
diag_pin: PG6
run_current: 0.600
driver_SGTHRS: 125 
stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PD11
diag_pin: PG9
run_current: 0.600
driver_SGTHRS: 125 
stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PC6
diag_pin: PG10
run_current: 0.600
stealthchop_threshold: 999999

[tmc2209 stepper_z1]
uart_pin: PC7
diag_pin: PG11
run_current: 0.600
stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PF2
run_current: 0.600
stealthchop_threshold: 999999

[tmc2209 extruder1]
uart_pin: PE4
run_current: 0.600
stealthchop_threshold: 999999


# A [probe] section can be defined instead with a pin: setting identical
# to the sensor_pin: for a bltouch
[bltouch]
sensor_pin: PB7
control_pin: PB6
x_offset: -40.6
y_offset: -9.1
#z_offset: 4.1


[bed_mesh] 
mesh_min: 5, 5 
mesh_max: 200, 235
probe_count: 6, 6 
speed: 50
horizontal_move_z: 7

[z_tilt]
z_positions: -30,110
  265,110 
points: 60,110
  230,110
retries: 5
retry_tolerance: 0.02 
speed:120
horizontal_move_z: 7



[safe_z_home]
home_xy_position: 100, 100 # Change coordinates to the center of your print bed
speed: 50
z_hop: 10               # Move up 10mm
z_hop_speed: 5


[gcode_macro T0]
gcode:
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder" MOTION_QUEUE="extruder"
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder1" MOTION_QUEUE=""
	SAVE_VARIABLE VARIABLE=active_tool VALUE='"T0"'

[gcode_macro T1]
gcode:
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder" MOTION_QUEUE=""
	SYNC_EXTRUDER_MOTION EXTRUDER="extruder1" MOTION_QUEUE="extruder"
	SAVE_VARIABLE VARIABLE=active_tool VALUE='"T1"'

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  500
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  500
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.752
#*# pid_ki = 1.792
#*# pid_kd = 718.421
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 32.602
#*# pid_ki = 2.110
#*# pid_kd = 125.927
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.195000, 0.127500, 0.082500, 0.047500, 0.020000, -0.007500
#*# 	0.140000, 0.087500, 0.077500, 0.080000, 0.080000, 0.087500
#*# 	0.072500, 0.017500, 0.007500, 0.017500, 0.030000, 0.065000
#*# 	0.142500, 0.077500, 0.055000, 0.057500, 0.060000, 0.075000
#*# 	0.235000, 0.182500, 0.167500, 0.180000, 0.190000, 0.212500
#*# 	0.472500, 0.420000, 0.410000, 0.437500, 0.460000, 0.480000
#*# x_count = 6
#*# y_count = 6
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 200.0
#*# min_y = 5.0
#*# max_y = 235.0
#*#
#*# [bltouch]
#*# z_offset = 4.080
